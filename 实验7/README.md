实验 7 游标的使用

# 一、实验目的

- 了解游标的定义和结构
- 掌握游标的声明、关闭和释放的方法
- 掌握从游标中提取数据的方法
- 掌握更新游标数据的方法
- 掌握游标的卷动方法

# 二、实验环境

- PC 机（CPU 主频 2.0GHz 以上，4G 以上内存，80GB 以上硬盘空间）
- Win 7 或 Win 10 操作系统
- SQL Server 2008（或以上版本）

# 三、实验内容

数据库 LoanDB 中包含三张关系表，数据模式如下：

| **Bank T** |                                   |                |
| ---------- | --------------------------------- | -------------- |
| **属性名** | **数据类型**                      | **说明**       |
| Bno        | 定长字符串，长度 5                | 银行编号，主键 |
| Bname      | 变长字符串，Unicode 编码，长度 10 | 银行名称       |
| Btel       | 定长字符串，长度 8                | 联系电话       |

| **LegalEntityT** |                                   |                |
| ---------------- | --------------------------------- | -------------- |
| **属性名**       | **数据类型**                      | **说明**       |
| Eno              | 定长字符串，长度 3                | 法人编号，主键 |
| Ename            | 变长字符串，Unicode 编码，长度 15 | 法人名称       |
| Enature          | 定长字符串，Unicode 编码，长度 2  | 经济性质       |
| Ecapital         | 整型                              | 注册资金       |
| Erep             | 变长字符串，Unicode 编码，长度 4  | 法人代表       |

| **LoanT**  |                    |                                         |
| ---------- | ------------------ | --------------------------------------- |
| **属性名** | **数据类型**       | **说明**                                |
| Eno        | 定长字符串，长度 3 | 银行编号，主键，参照关系表 LegalEntityT |
| Bno        | 定长字符串，长度 5 | 银行编号，主键，参照关系关系表 BankT    |
| Ldate      | 时间日期           | 放贷日期，主键                          |
| Lamount    | 整型               | 贷款金额（万元）                        |
| Lterm      | 整型               | 贷款年限                                |

请使用游标编写程序，完成以下任务，并在 SSMS 中执行，将执行结果截图： **任务 1：**  
定义一个查询上海的银行的游标，并使用 FETCH NEXT 逐个提取每行数据， 并按下列形式输出：  
银行代码:B1100 银行名称:工商银行北京分行 电话:010-4573 若银行的联系电话为空值，则输出“未知”

## 任务 2

利用存储过程和游标，实现查询指定城市的银行信息，并按下列形式输出： 银行代码:B1100 银行名称:工商银行北京分行 电话:010-4573  
若银行的联系电话为空值，则输出“未知” **任务 3：**  
统计每个法人的贷款情况，只考虑有贷款记录的法人，每个法人的贷款记录需要先按银行名称的升序排列，再按贷款日期的升序排列。  
![](https://cdn.nlark.com/yuque/0/2022/png/23075474/1642228298237-4947198f-0d8b-4c91-a931-d74c8eaebffc.png#)输出格式如下所示：

## 任务 4

查询每家银行总贷款金额最多的前两名（包括并列的情况）法人的贷款信息。列出银行名称、法人名称和总贷款金额。  
输出格式如下所示：

![](https://cdn.nlark.com/yuque/0/2022/png/23075474/1642228298667-9de2868a-ceb4-453d-8aa6-bc99e4cb061c.png#)

## 任务 5

统计每家银行提供贷款的次数，以及为哪些法人提供了贷款。输出格式如下所示：  
![](https://cdn.nlark.com/yuque/0/2022/png/23075474/1642228299099-52b0a4aa-8e02-4fa8-86a1-1dba65689332.png#)

## 任务 6

创建以下关系表：

| **Bank LoanInfoT**      |                            |                                                                                                  |
| ----------------------- | -------------------------- | ------------------------------------------------------------------------------------------------ |
| **属性名**              | **数据类型**               | **说明**                                                                                         |
| Bno                     | 定长字符串，长度           |
| 5                       | 银行编号，主键             |
| LoanNum                 | 整型                       | 提供贷款的次数                                                                                   |
| LoanEno                 | 变长字符串，最大长度为 100 | 贷款对象，以法人代码表示。如果有多个贷款对象，则用逗号间隔。如果没有贷款对象，则取值为空字符串。 |
| 例如：E01,E02,E09,E10 |

该关系表记录了每家银行的贷款情况，包括提供贷款的总次数，以及为哪位法人实体提供了贷款。  
请从 LoanT 表中提取数据并计算，并填入该关系表。
